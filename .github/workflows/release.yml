name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: macos-15
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build app bundle
        run: bash scripts/build-app.sh

      - name: Code sign (ad-hoc)
        run: codesign --force --deep -s - .build/release/BreakTime.app

      - name: Create DMG
        run: |
          STAGING=$(mktemp -d)
          cp -r .build/release/BreakTime.app "$STAGING/"
          ln -s /Applications "$STAGING/Applications"
          hdiutil create -volname BreakTime -srcfolder "$STAGING" -ov -format UDZO BreakTime.dmg
          rm -rf "$STAGING"

      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG=$(git tag --sort=-v:refname | grep '^v' | sed -n '2p')
          if [ -n "$PREV_TAG" ]; then
            LOG=$(git log --pretty=format:"- %s" "$PREV_TAG"..HEAD)
          else
            LOG=$(git log --pretty=format:"- %s")
          fi
          {
            echo "body<<EOF"
            echo "$LOG"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ github.ref_name }}
          body: ${{ steps.changelog.outputs.body }}
          files: BreakTime.dmg
